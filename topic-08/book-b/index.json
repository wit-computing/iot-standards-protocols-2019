


  {
  
  
    "properties" : {},
  
  "type" : "lab",
  "title" : "BLE",
  "img" : "img/main.png",
  "videoid" : "none",
  "objectives" : "<p>Bluez · Smartphone · Raspberry Pi · SenseHAT</p>",
  "folder" : "book-b",
  "link" : "index.html",
  "los": [
   ]
,
  "chapters" : [
  
    {
    "title": "# BLE Smart Light",
    "shortTitle": "BLE",
    "contentMd" : "# BLE Smart Light\r\n\r\nBluez · Smartphone · Raspberry Pi · SenseHAT\r\n\r\n## Introduction\r\n\r\nIn this lab you will use Bluetooth Low Energy (BLE) and a Raspberry Pi/SenseHAT to build a \"smart lightbulb\".\r\n\r\n\r\n## Equipment\r\n+ Raspberry pi 3\r\n+ SenseHAT\r\n+ Smartphone(Android/iPhone)\r\n+ OPTIONAL: Screen with HDMI, Keyboard, Mouse for RPi\r\n"
    },
  
    {
    "title": "# Configure your RPi for BLE",
    "shortTitle": "01",
    "contentMd" : "# Configure your RPi for BLE\r\n \r\n Your RPi has a built in Bluetooth protocol implementation called [Bluez](http://www.bluez.org/). However, as you will be creating a Bluetooth Low Energy service, it's a good idea to download, compile, install, and configure the latest stable version of Bluez on the Raspberry Pi.  \r\n\r\n ## Install Dependencies\r\nYour BLE service will require a few additional libraries on the RPi. Update the package list on your RPi  and install these dependencies as follows:\r\n~~~bash\r\n$ sudo apt-get update\r\n$ sudo apt-get install libdbus-1-dev libglib2.0-dev libudev-dev libical-dev libreadline-dev -y\r\n~~~\r\nYou'll have to wait a short while for the dependencies to install.\r\n\r\n## Check current Bluez version\r\nOpen a command prompt on your RPi and check the BlueZ Version you have currently on your RPi:\r\n~~~bash\r\n$ bluetoothctl -v\r\n~~~\r\nYou should see a reasonably current version (probably 5.43). If it's already 5.50 or greater then that's fine and you can move to the next section of the exercise.\r\n\r\n## Download and install BlueZ 5.50\r\n\r\nDownload the  BlueZ 5.50 source code on to your RPi using the ``wget`` command. Make sure your RPi has an internet connection.\r\n\r\n~~~bash\r\n$ wget www.kernel.org/pub/linux/bluetooth/bluez-5.50.tar.xz\r\n~~~\r\nUncompress the downloaded file using the ``tar`` command and change directory to the new uncompressed directory:\r\n\r\n~~~bash\r\n$ tar xvf bluez-5.50.tar.xz && cd bluez-5.50\r\n~~~\r\n\r\nTo install Bluez, you need to follow the standard configure-make-install process for most Linux software packages:\r\n\r\n~~~bash\r\n./configure --prefix=/usr --mandir=/usr/share/man --sysconfdir=/etc --localstatedir=/var --enable-experimental\r\n~~~\r\n\r\nOnce the configure script has successfully run you can compile the Bluez code.  This compilation will take about 10 minutes. Compile the code by running the ``make`` command:\r\n~~~bash\r\nmake -j4\r\n~~~\r\nAfter Bluez has been compiled it can be installed on the RPi by running the following command:\r\n~~~bash\r\nsudo make install\r\n~~~\r\nIf all the above runs without any difficulty then you've updated your Bluetooth stack to Bluez 5.50. Now reboot the RPi for it to fully take effect.\r\n~~~bash\r\nsudo reboot\r\n~~~\r\n\r\n## Verify Update\r\nVerify the BlueZ version by issuing the command below.\r\n~~~bash\r\n$ bluetoothctl -v\r\nbluetoothctl: 5.50\r\n~~~\r\n\r\n## Install python-dbus\r\n\r\n~~~bash\r\nsudo apt-get install python-dbus\r\n~~~\r\n\r\n## Install Git\r\nYou will need to download starter code for this lab from an online Git repo. To make this easy, install Git on your RPi by running the following command on the RPi:\r\n~~~bash\r\nsudo apt-get install git\r\n~~~"
    },
  
    {
    "title": "# The Raspberry Pi as BLE peripheral",
    "shortTitle": "02",
    "contentMd" : "# The Raspberry Pi as BLE peripheral\r\n\r\nYou will now use the Raspberry Pi to start advertising itself to BLE central devices and expose some data. \r\n\r\nThe example you will use is similar to some commercial BLE \"Smart Light\" products on the market at the moment. Typically they are controlled using a smart phone app whereby their colour and state(on/off) can be changed. They can also include other novel features. For example, [PlayBulb](http://www.playbulb.com/index.html) provide a BLE light that has a built in speaker that pulses and changes colour to match the mood of the music (a party bulb!). \r\n\r\nYou will now use the 8x8 LED matrix on the RPi to create a Smart light proto type that can be controlled from a Mobile device. It will provide the following functionality:\r\n\r\n- Control light colour\r\n- temperature \r\n\r\nBy adverising temperature, the lightbulb could posiibly be used as part of a smart home climate control system or as an ambient/assisted living device where the colour indicates temperature (blue -> too cold, red -> too hot).\r\n\r\n## Service Design\r\nYour RPi can have multiple BLE services. Each BLE service, in turn, can have multiple characteristics. Characteristics can be read-only, read/write, or notify. Our Smart Light will contain 2 services: a SmartLight service and a Temperature service.  \r\nThe BLE service design you will implement is shown in the following diagram:\r\n\r\n![Service Design](./img/service-design.png)\r\n\r\n### Smart Light Service\r\nThe Bluetooth Special interest group (SIG) has agreed specifications for BLE services and characteristics (for example Heart Rate Monitors). To date, there is no specific agreed standard for the light services and colour so we can define our own custom spec. Each service must have its own Universally Unique Identifier (UUID). You can use an online tool [GUID Generator](https://www.guidgenerator.com/online-guid-generator.aspx) to do this. For the purposes of this lab, we will use the following:\r\n\r\n> UUID_SMART_LIGHT_SRVC = 'FF00'  \r\nUUID_LIGHT_COLOUR_CHRC = 'FF01'  \r\nUUID_LIGHT_SWITCH = 'FF02'  \r\n\r\n### Temperature Service\r\nThere is an agreed standard for Temperature characteristics. Based on this, the UUID for temperature will use the short 16 bit UUID defined by the BLuetooth SIG:\r\n\r\n> UUID_TEMP_SRVC = '2A60'  \r\nUUID_TEMP_CHRC = '2A6E'\r\n  \r\n\r\n## Turn on BLE advertising\r\nBefore changing anything, lets check if the generic service example runs. \r\n\r\nFirst, change the bluetooth device name permanently to include your name so that it can be identified easily. On the Raspberry Pi, create a file called ``/etc/machine-info`` (perhaps use ``nano /etc/machine-info``) and add the following content:\r\n\r\n```bash\r\nPRETTY_HOSTNAME=YOUR_NAME\r\n```\r\n\r\nNext, configure your Bluetooth controller on the RPi to allow BLE advertising. At the command line on the RPi, run the following command to allow both reading and writing to ble services.\r\n\r\n~~~bash\r\nsudo hciconfig hci0 leadv 0\r\n~~~\r\n\r\n(\"leadv\" stands for LE Advertising...)\r\n## Clone Example Service\r\n\r\nOpen a terminal window and make sure you are in your home directory by entering ``cd ~``.  \r\n \r\nUse ``Git`` to clone the starter code for your GATT service. In your home directory, run the following command\r\n~~~bash\r\n~ $ git clone https://github.com/fxwalsh/Bluetooth-Low-Energy-LED-Matrix.git\r\n~~~\r\n\r\nChange directory to the cloned repository and examine the files in the src directory.\r\n\r\n~~~bash\r\n~ $ cd Bl*/src\r\n~/Bluetooth-Low-Energy-LED-Matrix/src $ ls\r\nbluez_components.py  gatt-server\r\n~~~\r\n\r\n``bluez_components.py`` contains \"boiler-plate\" functions that control the BLE adapter. The ``gatt-server`` implements a generic BLE service that we can modify to implement our Smart Light Service.\r\nAt the command prompt in the src directory, type ``sudo ./gatt-server`` to start the service. Hopefully there are no errors and you see something similar to the following:\r\n~~~bash\r\npi@sensePi:~/Bluetooth-Low-Energy-LED-Matrix/src $ sudo ./gatt-server\r\nRegistering GATT application...\r\nGetManagedObjects\r\nGATT application registered\r\n~~~\r\n\r\n\r\n## Explore your device\r\n\r\nYour RPi should now be advertising and waiting for a central device to connect to it. You can use a Smart phone app to do this. LightBlue Explorer is a BLE test app that allows you to scan for Bluetooth Low Energy devices and communicate with them. It also is available for both Android and Apple iOS Devices.\r\nGo to the App Store on your device and search for it using 'LightBlue' as the search word and install it on your device.\r\nThe following desciption is using Android version of LightBlue.\r\n\r\n## Scan for BLE Devices\r\nTo test our RPi Smart Light peripheral, we'll be using LightBlue in Central Mode which allows you to scan and connect to BLE peripherals. Start LightBlue on your device. After some onboarding messages it should start scanning and you should see nearby devices appear on the screen. You can choose a peripheral from a list of nearby devices and explore information about that connected peripheral, its services, and characteristics.  \r\n![LightBlue Peripheral List](./img/lightblue1.png)  \r\n\r\n\r\n## Connecting to the RPi\r\nFind the Smart Light peripheral in the list. Tap on the service to connect and you should see the advertisement data for the Demo Service showing just one characteristic.\r\n\r\n![LightBlue Service](./img/lightblue2.png) \r\n\r\n\r\n\r\nTap on the characteristic and, in \"Written Values\", enter \"FF00F0\" and hit Write; the screen should show the new value as 0xFF0F.\r\nHit the Read button and it should return the same value.  \r\n![LightBlue Characteristic](./img/lightblue4.png)  \r\nIf you now check the console output in the RPi where the service is running, you should see output confirming the write and read.  \r\n![RPi Console - GATT Service](./img/gatt-service1.png)  \r\nCongratulations, you've just implemented and tested a simple BLE peripheral on a Raspberry Pi. Now we will modify this service to control the LED matrix and read temperature sensor on the SenseHAT.\r\n\r\n## Stopping the Service\r\n\r\nTo stop the GATT server, enter ``ctrl+c`` in the RPi console. The console should then return to the command prompt. "
    },
  
    {
    "title": "# Implement SmartLight",
    "shortTitle": "03",
    "contentMd" : "# Implement SmartLight\r\n\r\n## GATT Server\r\n\r\nRename the ``gatt-server`` script to ``smartlight-gatt-server``.\r\n\r\nUsing ``nano`` or a suitable editor, open the ``smartlight-gatt-server`` file. You will see that it contains 3 python classes, ``DemoService``, ``DemoCharacteristic``, and ``CharacteristicUserDescriptionDescriptor``.\r\n\r\n## Include the SmartHAT\r\nYou will need a way to access the SenseHAT LEDs and temperature sensor from the SmartLight service. At the top of the ``smartlight-gatt-server`` script, add the following to import the SenseHAT package and create the ``sense`` object. \r\n~~~python\r\nfrom sense_hat import SenseHat\r\nsense = SenseHat()\r\n~~~\r\n\r\n## SmartLight Service\r\nChange the DemoService class to match the Smart Light design as follows:\r\n\r\n- change the class name to \"SmartLightService\"\r\n- change TEST_SVC_UUID to SVC_UUID\r\n- change the UUID to match the proposed design\r\n- change the characteristic name to LightColourCharacteristic\r\n\r\n~~~python\r\nclass SmartLightService(Service):\r\n    SVC_UUID = 'FF10'\r\n\r\n    def __init__(self, bus, index):\r\n        Service.__init__(self, bus, index, self.SVC_UUID, True)\r\n        self.add_characteristic(LightColourCharacteristic(bus, 0, self))\r\n~~~\r\n\r\n## LightColourCharacteristic\r\nUpdate the ``DemoCharacteristic`` class as follows\r\n\r\n- change the class name to \"LightColourCharacteristic\"\r\n- change the UUID to match the proposed design(FF11)\r\n- in the ``__init__`` function (i.e. the constructor):\r\n  - initialise the light colour value to 0,0,0 (representing RGB)\r\n  - clear the SenseHAT LED matrix\r\n\r\n~~~python\r\nclass LightColourCharacteristic(Characteristic):\r\n    CHRC_UUID = 'FF11'\r\n\r\n    def __init__(self, bus, index, service):\r\n        Characteristic.__init__(\r\n                self, bus, index,\r\n                self.CHRC_UUID,\r\n                ['read', 'write', 'writable-auxiliaries'],\r\n                service)\r\n        self.value = [0,0,0]\r\n        sense.clear()\r\n        self.add_descriptor(\r\n                LightColourUserDescription(bus, 0, self))\r\n~~~\r\n\r\nWhenever a value is received from a connected client, change the colour of the LED matrix to the received value. Find the ``WriteValue`` function in the script and change it to the following:\r\n~~~python\r\n    def WriteValue(self, value, options):\r\n        print('light Colour WriteValue called')\r\n        if len(value)!=3:\r\n            raise InvalidValueLengthException()\r\n        sense.clear([int(value[0]),int(value[1]),int(value[2])])\r\n        self.value = value\r\n        print('Finished changing colour!')\r\n~~~\r\n\r\n## Light Colour User Description\r\nFinally, change the name of the ``CharacteristicUserDescriptionDescriptor`` class and update the ``value`` field to a more accurate description of the characteristic:\r\n~~~python\r\nclass LightColourUserDescription(Descriptor):\r\n    CUD_UUID = '2901'\r\n\r\n    def __init__(self, bus, index, characteristic):\r\n        self.writable = 'writable-auxiliaries' in characteristic.flags\r\n        self.value = array.array('B', b'Smart Light Colour(RGB)')\r\n        self.value = self.value.tolist()\r\n        Descriptor.__init__(\r\n                self, bus, index,\r\n                self.CUD_UUID,\r\n                ['read', 'write'],\r\n                characteristic)\r\n...\r\n...\r\n~~~\r\n\r\n## Update main() function\r\nFind the ``main()`` function in the script. Replace the line that adds the Demo Service (``app.add_service(DemoService(bus, 1))``) to the following:\r\n\r\n~~~python\r\napp.add_service(SmartLightService(bus, 0))\r\n~~~\r\n\r\n## Run it!\r\nIf the example service is still running, stop it using ``ctrl+c``. As before, run the service by entering ``sudo ./smartlight-gatt-server`` at the RPi command prompt and connect using LightBlue on your device. \r\nWrite \"FFFFFF\" to the light colour characteristic and you should see the SenseHAT LED matrix light up. Try some other colours to make sure it's working.\r\n\r\n## Any Problems?\r\nBluetooth can be tricky. When you make changes to your service you may need to stop and start Bluetooth on your device/smartphone.  \r\nIf you cannot see the service on your device, restart Bluetooth on the RPi and make sure Low Energy Advertising is allowed:\r\n~~~bash\r\nsudo hciconfig hci0 down\r\nsudo hciconfig hci0 up\r\nsudo hciconfig hci0 leadv 0\r\n~~~\r\n\r\n"
    },
  
    {
    "title": "# Temperature Service",
    "shortTitle": "04",
    "contentMd" : "# Temperature Service\r\n\r\nNow you will add another service to the RPi GATT server. The Temperature service will read from the temperature sensor on the SenseHAT and provide both read and notify functionality for the temperature characteristic.\r\n\r\nThe environment service design is as follows:\r\n\r\n![Environment Service](./img/env-service.png)\r\n\r\nThe design applies the UUIDs for environment sensing service and temperature characteristic specified by the Bluetooth SIG.\r\n\r\n## Environment Service Class\r\n**NOTE: ALL THE FOLLOWING CODE SHOULD BE ADDED ABOVE THE ``main()`` FUNCTION**\r\n\r\nAdd the following class to the ``smartlight-gatt-server`` script:\r\n\r\n~~~python\r\nclass EnvironmentService(Service):\r\n    \r\n    ENV_UUID = '181a'\r\n\r\n    def __init__(self, bus, index):\r\n        Service.__init__(self, bus, index, self.ENV_UUID, True)\r\n        self.add_characteristic(TemperatureCharacteristic(bus, 0, self))\r\n\r\n~~~\r\n\r\nAs you can see the service uses the reserved UUID for Environment Sensing services and adds just on characteristic, ``TemperatureCharacteristic``\r\n\r\n## Temperature Characteristic class\r\n\r\nAdd the folowing class to the ``smartlight-gatt-server`` script.\r\n\r\n~~~python\r\nclass TemperatureCharacteristic(Characteristic):\r\n    TEMP_UUID = '2a6e'\r\n\r\n    def __init__(self, bus, index, service):\r\n        Characteristic.__init__(\r\n                self, bus, index,\r\n                self.TEMP_UUID,\r\n                ['read', 'notify'],\r\n                service)\r\n        self.notifying = False\r\n        self.temp = temp_sint16(sense.get_temperature())\r\n        GObject.timeout_add(1000, self.get_temp)\r\n\r\n    def notify_temp(self):\r\n        if not self.notifying:\r\n            return\r\n        self.PropertiesChanged(\r\n                GATT_CHRC_IFACE,\r\n                                { 'Value': self.temp }, [])\r\n        print('temp notify: ' + repr(self.temp))\r\n        return self.notifying\r\n\r\n    def get_temp(self):\r\n        self.temp = temp_sint16(sense.get_temperature())\r\n        if not self.notifying:\r\n            return True\r\n        self.notify_temp()\r\n        return True\r\n\r\n    def ReadValue(self, options):\r\n        self.get_temp()\r\n        print('temp read: ' + repr(self.temp))\r\n        return self.temp\r\n\r\n    def StartNotify(self):\r\n        if self.notifying:\r\n            print('Already notifying, nothing to do')\r\n            return\r\n        self.notifying = True\r\n\r\n    def StopNotify(self):\r\n        if not self.notifying:\r\n            print('Not notifying, nothing to do')\r\n            return\r\n        self.notifying = False\r\n\r\n## Utility function to convert temp value to 16 bit int value, preserving 2 decimal places\r\ndef temp_sint16(value):\r\n    answer = []\r\n    value_int16=int(value * 100).to_bytes(2, byteorder='little', signed=True)\r\n    for bytes in value_int16:\r\n        answer.append(dbus.Byte(bytes))\r\n    return answer\r\n~~~\r\n\r\nFinally, add the Environment Service to the application by adding the following line to the ``main()`` function:\r\n\r\n```python\r\n app.add_service(EnvironmentService(bus, 1))\r\n```\r\n\r\nNotice that this characteristic permits notifications and includes ``StartNotify`` and ``StopNotify`` functions to control notifications sent to a connected device. The service requests the temperature from the SenseHAT every  second (1Hz) by using the ``GObject.timeout_add()`` function.\r\n\r\n## Run it!\r\nNow run the service again. You should now see a new service included for your smartlight device. \r\nTo read the temperature from the device, do "
    },
  
    {
    "title": "# Automate GATT service on Startup",
    "shortTitle": "05",
    "contentMd" : "# Automate GATT service on Startup\r\nAt the moment, you have to run your GATT service manually on the RPi. Ideally, your script would run automatically when the RPi boots.\r\nOne way to do this is to edit the Cron Table.\r\n\r\n## Crontab\r\n[cron](https://en.wikipedia.org/wiki/Cron) is a utility that allows tasks to be automatically run in the background at regular intervals. The Crontab (CRON TABle) is a file which contains the schedule of cron entries to be run and at specified times. The crontab File location varies by operating system however you can easily access it on the RPi using the ``crontab`` utility program.  \r\nIn a terminal window, enter ``sudo crontab -e`` at the prompt:\r\n![Crontab](./img/cron1.png)  \r\nIf prompted, follow the instructions and select your favourite editor (default is nano). At the end of the file, add:\r\n\r\n```bash\r\n@reboot sleep 30 && sudo hciconfig hci0 leadv 0\r\n@reboot sleep 40 && sudo python3 /home/pi/Bluetooth-Low-Energy-LED-Matrix/src/smartlight-gatt-server\r\n```\r\n\r\nThe ``sleep`` commands delay the startup of the GATT server long enough for the supporting services on the Pi to start (i.e. Bluetooth service)\r\nSave and exit the Crontab and reboot the RPi by typing ``sudo reboot`` at the command prompt. \r\nThe BLE device should start advertising in the background on every reboot of the RPi.\r\n"
    },
  
    {
    "title": "# Exercises/Report",
    "shortTitle": "06",
    "contentMd" : "# Exercises/Report\r\n\r\nInclude the following in your lab report\r\n\r\n1. If possible, include screen shots of your service working. \r\n2. Lessons learned\r\n3. Issues encountered and how you resolved them.\r\n4. Final version of the code you created (or a link to an online repository)\r\n3. We used the ``hciconfig`` command in this lab. Investigate and explain how this command could be used to turn the Raspberry Pi into a broadcast-only BLE device. \r\n4. Explain how the ``hcitool`` command can be used to advertise data. \r\n\r\n## Optional:\r\n4. Include a ``Light Switch`` characteristic in the SmartLight service that turns the LED Matrix on and off. You should consider the following:  \r\nThe light has two states: ``on`` and ``off``. If the state is set to off, the LED matrix should be off. If the state is on, the LED matrix should be set to the ``value`` of the light colour characteristic (``sense.clear(value[0],value[1],value[2])``)."
    }
  
  ]
  }

